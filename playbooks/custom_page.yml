---
- hosts: webservers
  gather_facts: True
  become: yes
  become_method: sudo

  tasks:
    - name: Install Apache
      package:
        name: httpd
        state: present

    - name: Start Apache service
      service:
        name: httpd
        state: started

    - name: Check if hello.txt exists
      stat:
        path: /home/vagrant/hello.txt
      register: file_exists

    - name: Grab file contents to put on index.html
      slurp:
        src: /home/vagrant/hello.txt
      register: hello_text
      when: file_exists.stat.exists

    - name: Decode slurped contents
      set_fact:
        message: "{{ hello_text['content'] | b64decode }}"
      when: file_exists.stat.exists

    - name: Add custom welcome page
      template:
        src: ../templates/index.html.j2
        dest: /var/www/html/index.html

    - name: Restart Apache
      service:
        name: httpd
        state: restarted
